#!/bin/bash
#
# Copies the production database to a schema named "aoserv1".  Database must be empty.
#
set -e
DIR=`dirname "$0"`
read -p "Please confirm database is empty (\d and \dn) then press <Enter>: "
(
  # Copy the production database
  ssh aoadmin@master.aoindustries.com /opt/postgresql-8.3-i686/bin/pg_dump \
    -p 5447 \
    --blobs \
    --no-owner \
    --no-privileges \
    aoindustries

  # Remove unnecessary views
  cat <<EOF
  drop view account_balances;
  drop view bank_monthly_detail;
  drop view bank_summary;
  drop view bank_summary_monthly;
  drop view bank_transactions_verify;
  drop view earnings_and_losses;
  drop view salary_report;
  drop view server_stats;

  -- Move copy into different schema
  create schema aoserv1;
  alter table ao_server_daemon_hosts set schema aoserv1;
  alter sequence ao_server_daemon_hosts_pkey_seq set schema aoserv1;
  alter table ao_servers set schema aoserv1;
  alter table aoserv_permissions set schema aoserv1;
  alter table aoserv_protocols set schema aoserv1;
  alter table aosh_commands set schema aoserv1;
  alter table architectures set schema aoserv1;
  alter table backup_partitions set schema aoserv1;
  alter sequence backup_partitions_pkey_seq set schema aoserv1;
  alter table backup_reports set schema aoserv1;
  alter sequence backup_reports_pkey_seq set schema aoserv1;
  alter table backup_retentions set schema aoserv1;
  alter table bank_accounts set schema aoserv1;
  alter table bank_transaction_types set schema aoserv1;
  alter table bank_transactions set schema aoserv1;
  alter sequence bank_transactions_transid_seq set schema aoserv1;
  alter table banks set schema aoserv1;
  alter table blackhole_email_addresses set schema aoserv1;
  alter table brands set schema aoserv1;
  alter table business_administrator_permissions set schema aoserv1;
  alter sequence business_administrator_permissions_pkey_seq set schema aoserv1;
  alter table business_administrators set schema aoserv1;
  alter table business_profiles set schema aoserv1;
  alter sequence business_profiles_pkey_seq set schema aoserv1;
  alter table business_servers set schema aoserv1;
  alter sequence business_servers_pkey_seq set schema aoserv1;
  alter table businesses set schema aoserv1;
  alter table country_codes set schema aoserv1;
  alter table credit_card_processors set schema aoserv1;
  alter table credit_card_transactions set schema aoserv1;
  alter sequence credit_card_transactions_pkey_seq set schema aoserv1;
  alter table credit_cards set schema aoserv1;
  alter sequence credit_cards_pkey_seq set schema aoserv1;
  alter table cvs_repositories set schema aoserv1;
  alter sequence cvs_repositories_pkey_seq set schema aoserv1;
  alter table disable_log set schema aoserv1;
  alter sequence disable_log_pkey_seq set schema aoserv1;
  alter table disk_types set schema aoserv1;
  alter table distro_file_types set schema aoserv1;
  alter table distro_files set schema aoserv1;
  alter sequence distro_files_pkey_seq set schema aoserv1;
  alter table dns_forbidden_zones set schema aoserv1;
  alter table dns_records set schema aoserv1;
  alter table dns_records_jca set schema aoserv1;
  alter sequence dns_records_pkey_seq set schema aoserv1;
  alter table dns_tlds set schema aoserv1;
  alter table dns_types set schema aoserv1;
  alter table dns_zones set schema aoserv1;
  alter table dns_zones_jca set schema aoserv1;
  alter table email_addresses set schema aoserv1;
  alter sequence email_addresses_pkey_seq set schema aoserv1;
  alter table email_attachment_blocks set schema aoserv1;
  alter sequence email_attachment_blocks_pkey_seq set schema aoserv1;
  alter table email_attachment_types set schema aoserv1;
  alter table email_domains set schema aoserv1;
  alter sequence email_domains_pkey_seq set schema aoserv1;
  alter table email_forwarding set schema aoserv1;
  alter sequence email_forwarding_pkey_seq set schema aoserv1;
  alter table email_list_addresses set schema aoserv1;
  alter sequence email_list_addresses_pkey_seq set schema aoserv1;
  alter table email_lists set schema aoserv1;
  alter sequence email_lists_pkey_seq set schema aoserv1;
  alter table email_pipe_addresses set schema aoserv1;
  alter sequence email_pipe_addresses_pkey_seq set schema aoserv1;
  alter table email_pipes set schema aoserv1;
  alter sequence email_pipes_pkey_seq set schema aoserv1;
  alter table email_sa_integration_modes set schema aoserv1;
  alter table email_smtp_relay_types set schema aoserv1;
  alter table email_smtp_relays set schema aoserv1;
  alter sequence email_smtp_relays_pkey_seq set schema aoserv1;
  alter table email_smtp_smart_host_domains set schema aoserv1;
  alter sequence email_smtp_smart_host_domains_pkey_seq set schema aoserv1;
  alter table email_smtp_smart_hosts set schema aoserv1;
  alter table encryption_keys set schema aoserv1;
  alter sequence encryption_keys_pkey_seq set schema aoserv1;
  alter table expense_categories set schema aoserv1;
  alter table failover_file_log set schema aoserv1;
  alter sequence failover_file_log_pkey_seq set schema aoserv1;
  alter table failover_file_replications set schema aoserv1;
  alter sequence failover_file_replications_pkey_seq set schema aoserv1;
  alter table failover_file_schedule set schema aoserv1;
  alter sequence failover_file_schedule_pkey_seq set schema aoserv1;
  alter table failover_mysql_replications set schema aoserv1;
  alter sequence failover_mysql_replications_pkey_seq set schema aoserv1;
  alter table file_backup_settings set schema aoserv1;
  alter sequence file_backup_settings_pkey_seq set schema aoserv1;
  alter table ftp_guest_users set schema aoserv1;
  alter table httpd_binds set schema aoserv1;
  alter table httpd_jboss_sites set schema aoserv1;
  alter table httpd_jboss_versions set schema aoserv1;
  alter table httpd_jk_codes set schema aoserv1;
  alter table httpd_jk_protocols set schema aoserv1;
  alter table httpd_servers set schema aoserv1;
  alter sequence httpd_servers_pkey_seq set schema aoserv1;
  alter table httpd_shared_tomcats set schema aoserv1;
  alter sequence httpd_shared_tomcats_pkey_seq set schema aoserv1;
  alter table httpd_site_authenticated_locations set schema aoserv1;
  alter sequence httpd_site_authenticated_locations_pkey_seq set schema aoserv1;
  alter table httpd_site_binds set schema aoserv1;
  alter sequence httpd_site_binds_pkey_seq set schema aoserv1;
  alter table httpd_site_urls set schema aoserv1;
  alter sequence httpd_site_urls_pkey_seq set schema aoserv1;
  alter table httpd_sites set schema aoserv1;
  alter sequence httpd_sites_pkey_seq set schema aoserv1;
  alter table httpd_static_sites set schema aoserv1;
  alter table httpd_tomcat_contexts set schema aoserv1;
  alter sequence httpd_tomcat_contexts_pkey_seq set schema aoserv1;
  alter table httpd_tomcat_data_sources set schema aoserv1;
  alter sequence httpd_tomcat_data_sources_pkey_seq set schema aoserv1;
  alter table httpd_tomcat_parameters set schema aoserv1;
  alter sequence httpd_tomcat_parameters_pkey_seq set schema aoserv1;
  alter table httpd_tomcat_shared_sites set schema aoserv1;
  alter table httpd_tomcat_sites set schema aoserv1;
  alter table httpd_tomcat_std_sites set schema aoserv1;
  alter table httpd_tomcat_versions set schema aoserv1;
  alter table httpd_workers set schema aoserv1;
  alter sequence httpd_workers_pkey_seq set schema aoserv1;
  alter table ip_addresses set schema aoserv1;
  alter sequence ip_addresses_pkey_seq set schema aoserv1;
  alter table languages set schema aoserv1;
  alter table linux_acc_addresses set schema aoserv1;
  alter sequence linux_acc_addresses_pkey_seq set schema aoserv1;
  alter table linux_account_types set schema aoserv1;
  alter table linux_accounts set schema aoserv1;
  alter table linux_group_accounts set schema aoserv1;
  alter sequence linux_group_accounts_pkey_seq set schema aoserv1;
  alter table linux_group_types set schema aoserv1;
  alter table linux_groups set schema aoserv1;
  alter table linux_ids set schema aoserv1;
  alter table linux_server_accounts set schema aoserv1;
  alter sequence linux_server_accounts_pkey_seq set schema aoserv1;
  alter table linux_server_groups set schema aoserv1;
  alter sequence linux_server_groups_pkey_seq set schema aoserv1;
  alter table majordomo_lists set schema aoserv1;
  alter table majordomo_servers set schema aoserv1;
  alter table majordomo_versions set schema aoserv1;
  alter table master_hosts set schema aoserv1;
  alter sequence master_hosts_pkey_seq set schema aoserv1;
  alter table master_servers set schema aoserv1;
  alter sequence master_servers_pkey_seq set schema aoserv1;
  alter table master_users set schema aoserv1;
  alter table monthly_charges set schema aoserv1;
  alter sequence monthly_charges_pkey_seq set schema aoserv1;
  alter table mysql_databases set schema aoserv1;
  alter sequence mysql_databases_pkey_seq set schema aoserv1;
  alter table mysql_db_users set schema aoserv1;
  alter sequence mysql_db_users_pkey_seq set schema aoserv1;
  alter table mysql_reserved_words set schema aoserv1;
  alter table mysql_server_users set schema aoserv1;
  alter sequence mysql_server_users_pkey_seq set schema aoserv1;
  alter table mysql_servers set schema aoserv1;
  alter sequence mysql_servers_pkey_seq set schema aoserv1;
  alter table mysql_users set schema aoserv1;
  alter table net_binds set schema aoserv1;
  alter sequence net_binds_pkey_seq set schema aoserv1;
  alter table net_device_ids set schema aoserv1;
  alter table net_devices set schema aoserv1;
  alter sequence net_devices_pkey_seq set schema aoserv1;
  alter table net_ports set schema aoserv1;
  alter table net_protocols set schema aoserv1;
  alter table net_tcp_redirects set schema aoserv1;
  alter table notice_log set schema aoserv1;
  alter sequence notice_log_pkey_seq set schema aoserv1;
  alter table notice_types set schema aoserv1;
  alter table operating_system_versions set schema aoserv1;
  alter sequence operating_system_versions_pkey_seq set schema aoserv1;
  alter table operating_systems set schema aoserv1;
  alter table package_categories set schema aoserv1;
  alter table package_definition_limits set schema aoserv1;
  alter sequence package_definition_limits_pkey_seq set schema aoserv1;
  alter table package_definitions set schema aoserv1;
  alter sequence package_definitions_pkey_seq set schema aoserv1;
  alter table packages set schema aoserv1;
  alter sequence packages_pkey_seq set schema aoserv1;
  alter table payment_types set schema aoserv1;
  alter table physical_servers set schema aoserv1;
  alter table postgres_databases set schema aoserv1;
  alter sequence postgres_databases_pkey_seq set schema aoserv1;
  alter table postgres_encodings set schema aoserv1;
  alter sequence postgres_encodings_pkey_seq set schema aoserv1;
  alter table postgres_reserved_words set schema aoserv1;
  alter table postgres_server_users set schema aoserv1;
  alter sequence postgres_server_users_pkey_seq set schema aoserv1;
  alter table postgres_servers set schema aoserv1;
  alter sequence postgres_servers_pkey_seq set schema aoserv1;
  alter table postgres_users set schema aoserv1;
  alter table postgres_versions set schema aoserv1;
  alter table private_ftp_servers set schema aoserv1;
  alter table processor_types set schema aoserv1;
  alter table protocols set schema aoserv1;
  alter table racks set schema aoserv1;
  alter sequence racks_pkey_seq set schema aoserv1;
  alter table raid_types set schema aoserv1;
  alter table resellers set schema aoserv1;
  alter table resources set schema aoserv1;
  alter table schema_columns set schema aoserv1;
  alter sequence schema_columns_pkey_seq set schema aoserv1;
  alter table schema_foreign_keys set schema aoserv1;
  alter sequence schema_foreign_keys_pkey_seq set schema aoserv1;
  alter table schema_tables set schema aoserv1;
  alter table schema_types set schema aoserv1;
  alter table server_farms set schema aoserv1;
  alter table servers set schema aoserv1;
  alter sequence servers_pkey_seq set schema aoserv1;
  alter table shells set schema aoserv1;
  alter table signup_request_options set schema aoserv1;
  alter sequence signup_request_options_pkey_seq set schema aoserv1;
  alter table signup_requests set schema aoserv1;
  alter sequence signup_requests_pkey_seq set schema aoserv1;
  alter table spam_email_messages set schema aoserv1;
  alter sequence spam_email_messages_pkey_seq set schema aoserv1;
  alter table system_email_aliases set schema aoserv1;
  alter sequence system_email_aliases_pkey_seq set schema aoserv1;
  alter table technologies set schema aoserv1;
  alter sequence technologies_pkey_seq set schema aoserv1;
  alter table technology_classes set schema aoserv1;
  alter table technology_names set schema aoserv1;
  alter table technology_versions set schema aoserv1;
  alter sequence technology_versions_pkey_seq set schema aoserv1;
  alter table ticket_action_types set schema aoserv1;
  alter table ticket_actions set schema aoserv1;
  alter sequence ticket_actions_pkey_seq set schema aoserv1;
  alter table ticket_assignments set schema aoserv1;
  alter sequence ticket_assignments_pkey_seq set schema aoserv1;
  alter table ticket_brand_categories set schema aoserv1;
  alter table ticket_categories set schema aoserv1;
  alter sequence ticket_pkey_seq set schema aoserv1;
  alter table ticket_priorities set schema aoserv1;
  alter table ticket_stati set schema aoserv1;
  alter table ticket_types set schema aoserv1;
  alter table tickets set schema aoserv1;
  alter table time_zones set schema aoserv1;
  alter table transaction_types set schema aoserv1;
  alter table transactions set schema aoserv1;
  alter sequence transactions_transid_seq set schema aoserv1;
  alter table us_states set schema aoserv1;
  alter table usernames set schema aoserv1;
  alter table virtual_disks set schema aoserv1;
  alter sequence virtual_disks_pkey_seq set schema aoserv1;
  alter table virtual_servers set schema aoserv1;
  alter table whois_history set schema aoserv1;
  alter sequence whois_history_pkey_seq set schema aoserv1;
  vacuum full analyze;
EOF
) | /ao/bin/ssh aoadmin@192.168.1.129 "psql -p 5433 aoindustries" 2>&1 | grep -i error
